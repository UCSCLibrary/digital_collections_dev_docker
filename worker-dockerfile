FROM registry.gitlab.com/notch8/ucsc-docker/webapp:latest

USER root

RUN echo "deb http://ftp.debian.org/debian stretch-backports main" >> /etc/apt/sources.list

RUN apt-get -qq update \
    && apt-get install -y --no-install-recommends  \
      unzip \
      ghostscript \
      libmagickcore-dev \
      mediainfo \
      clamav \
      libclamav-dev \
      ffmpeg \
      libreoffice
                                               
RUN apt-get install -y --no-install-recommends -t stretch-backports \
    openjdk-8-jre-headless \
    ca-certificates-java

# install fits
RUN mkdir /srv/fits
RUN wget https://github.com/harvard-lts/fits/releases/download/1.5.0/fits-1.5.0.zip
RUN unzip fits-1.5.0.zip -d /srv/fits
RUN chown -R hycruz:hycruz /srv/fits

USER hycruz

# install kakadu
COPY kakadu /usr/share/kakadu
ENV PATH $GEM_HOME/bin:$GEM_HOME/gems/bin:/usr/share/kakadu:$PATH
ENV LD_LIBRARY_PATH /usr/share/kakadu:$LD_LIBRARY_PATH

COPY sidekiq-entrypoint.sh /srv/sidekiq-entrypoint.sh
ENTRYPOINT ["/srv/sidekiq-entrypoint.sh"]
