version: "3"

services:
  web:
    image: registry.gitlab.com/notch8/ucsc-docker/webapp:latest
    build:  
      context: .
      dockerfile: webapp-dockerfile
    container_name: hycruz
    volumes:
     - "dams_derivatives:/dams_derivatives:Z"
    depends_on:
      - "db"
      - "repo"
      - "index"
    ports:
      - "3000:3000"
    env_file:
      - .env
    networks:
      front-tier:
        aliases: 
          - hycruz
          - hyrax
          - app
          - application
      back-tier:
        aliases:
          - hycruz
          - hyrax
          - app
          - application
  repo:
    image: registry.gitlab.com/notch8/ucsc-docker/repo:latest
    build:  
      context: .
      dockerfile: repo-dockerfile
    container_name: fcrepo
    ports:
      - "8080:8080"
    networks:
      back-tier:
        aliases:
          - repository
          - fedora
  db:
    image: mysql:5.7
    container_name: mysql
    ports:
      - "3306:3306"
      - "33060:33060"
    env_file:
      - .env
    restart: always
    networks:
      back-tier:
        aliases:
          - database
          - mysql
  index:
    image: registry.gitlab.com/notch8/ucsc-docker/index:latest
    build: 
      context: .
      dockerfile: index-dockerfile
    container_name: solr
    command: "bash -c 'solr-foreground'"
    ports: 
      - "8983:8983"
    environment:
      SOLR_HOME: /opt/solr/server/solr
    networks:
      back-tier:
        aliases:
          - solr
volumes:
  dams_ingest:
  dams_derivatives:
networks:
  front-tier:
  back-tier:
